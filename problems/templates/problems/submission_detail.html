{% extends 'base.html' %}
{% load static %}

{% block title %}Submission #{{ submission.id }} - CodePlatform{% endblock %}

{% block meta_description %}View detailed results for submission #{{ submission.id }} of {{ submission.problem.title }}.{% endblock %}

{% block extra_css %}
<style>
.line-numbers {
    counter-reset: line;
}
.line-numbers .line::before {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 3em;
    padding-right: 0.5em;
    margin-right: 0.5em;
    text-align: right;
    color: #6b7280;
    border-right: 1px solid #e5e7eb;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'problems:detail' submission.problem.id %}" class="inline-flex items-center text-gray-500 hover:text-gray-700 transition-colors duration-200">
            <i class="fas fa-arrow-left mr-2"></i>Back to Problem
        </a>
    </div>

    <!-- Submission Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-900">
                Submission #{{ submission.id }}
            </h1>
            <div class="flex items-center space-x-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border
                    {% if submission.status == 'ACCEPTED' %}status-accepted{% elif submission.status == 'WRONG_ANSWER' %}status-wrong-answer{% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}status-time-limit{% elif submission.status == 'RUNTIME_ERROR' %}bg-purple-100 text-purple-800 border-purple-200{% elif submission.status == 'COMPILATION_ERROR' %}bg-orange-100 text-orange-800 border-orange-200{% else %}status-pending{% endif %}">
                    {% if submission.status == 'ACCEPTED' %}
                        <i class="fas fa-check mr-2"></i>
                    {% elif submission.status == 'WRONG_ANSWER' %}
                        <i class="fas fa-times mr-2"></i>
                    {% elif submission.status == 'TIME_LIMIT_EXCEEDED' %}
                        <i class="fas fa-clock mr-2"></i>
                    {% elif submission.status == 'RUNTIME_ERROR' %}
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                    {% elif submission.status == 'COMPILATION_ERROR' %}
                        <i class="fas fa-times-circle mr-2"></i>
                    {% else %}
                        <i class="fas fa-hourglass-half mr-2"></i>
                    {% endif %}
                    {{ submission.get_status_display }}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">{{ submission.problem.title }}</div>
                <div class="text-sm text-gray-500">Problem</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">{{ submission.language|upper }}</div>
                <div class="text-sm text-gray-500">Language</div>
            </div>
            {% if submission.passed_test_cases is not None and submission.total_test_cases is not None %}
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">{{ submission.passed_test_cases }}/{{ submission.total_test_cases }}</div>
                <div class="text-sm text-gray-500">Test Cases</div>
            </div>
            {% endif %}
            {% if submission.execution_time %}
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">{{ submission.execution_time|floatformat:3 }}s</div>
                <div class="text-sm text-gray-500">Runtime</div>
            </div>
            {% endif %}
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="text-sm text-gray-500">
                Submitted {{ submission.submitted_at|timesince }} ago
                {% if submission.score is not None %}
                    â€¢ Score: {{ submission.score|floatformat:1 }}%
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Code -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900">Submitted Code</h3>
            </div>
            <div class="p-0">
                <pre class="bg-gray-900 text-gray-100 p-6 overflow-x-auto text-sm line-numbers"><code class="language-{{ submission.language }}">{{ submission.code }}</code></pre>
            </div>
        </div>

        <!-- Test Results -->
        <div class="space-y-6">
            {% if submission.error_data %}
            <!-- Error Information -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                    <h3 class="text-lg font-semibold text-red-900">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error Details
                    </h3>
                </div>
                <div class="p-6">
                    <pre class="bg-red-50 text-red-900 p-4 rounded-lg text-sm whitespace-pre-wrap">{{ submission.error_data }}</pre>
                </div>
            </div>
            {% endif %}

            {% if test_results %}
            <!-- Test Case Results -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Test Case Results</h3>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for result in test_results %}
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium text-gray-900">Test Case {{ forloop.counter }}</h4>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if result.status == 'PASSED' %}bg-green-100 text-green-800{% elif result.status == 'FAILED' %}bg-red-100 text-red-800{% elif result.status == 'TIME_LIMIT_EXCEEDED' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if result.status == 'PASSED' %}
                                    <i class="fas fa-check mr-1"></i>Passed
                                {% elif result.status == 'FAILED' %}
                                    <i class="fas fa-times mr-1"></i>Failed
                                {% elif result.status == 'TIME_LIMIT_EXCEEDED' %}
                                    <i class="fas fa-clock mr-1"></i>Time Limit
                                {% else %}
                                    {{ result.status }}
                                {% endif %}
                            </span>
                        </div>

                        {% if result.test_case.is_sample %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Input</div>
                                <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">{{ result.test_case.input_data }}</pre>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Expected Output</div>
                                <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">{{ result.test_case.expected_output }}</pre>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.actual_output %}
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">Your Output</div>
                            <pre class="bg-blue-50 p-3 rounded text-sm overflow-x-auto">{{ result.actual_output }}</pre>
                        </div>
                        {% endif %}

                        {% if result.error_message %}
                        <div class="mb-4">
                            <div class="text-sm font-medium text-red-700 mb-2">Error Message</div>
                            <pre class="bg-red-50 p-3 rounded text-sm overflow-x-auto text-red-800">{{ result.error_message }}</pre>
                        </div>
                        {% endif %}

                        {% if result.execution_time %}
                        <div class="text-sm text-gray-500">
                            Runtime: {{ result.execution_time|floatformat:3 }}s
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <a href="{% url 'problems:detail' submission.problem.id %}" class="btn-primary text-center">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </a>
                    <button onclick="copyCode()" class="btn-secondary text-center">
                        <i class="fas fa-copy mr-2"></i>Copy Code
                    </button>
                    <a href="{% url 'problems:list' %}" class="btn-secondary text-center">
                        <i class="fas fa-list mr-2"></i>More Problems
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyCode() {
    const code = `{{ submission.code|escapejs }}`;
    navigator.clipboard.writeText(code).then(() => {
        CodePlatform.showToast('Code copied to clipboard!', 'success');
    }).catch(() => {
        CodePlatform.showToast('Failed to copy code', 'error');
    });
}
</script>
{% endblock %}